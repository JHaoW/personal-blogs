#### 浏览器有哪些进程

* 主进程，对子进程进行管理，处理用户操作及文件存储等

* GPU进程

* 网络进程，是面向渲染进程和浏览器进程等提供网络下载功能

* 插件进程，运行在安全沙箱中，防止插件崩溃导致无法运行浏览器

* 渲染进程，运行在安全沙箱中

  ![渲染进程](../images/渲染进程.png)

#### 浏览器输入URL，到页面渲染，发生了什么

1. UI线程判断是不是URL，如果是则组装协议，构成完整的url，并通知网络进程处理（IPC：进程间通信）
1. 服务器响应后，网络进程接收响应头和响应信息，并解析响应内容，如果状态为200且响应类型是HTML的情况下，浏览器开始准备渲染进程
1. 浏览器进程检查当前URL是否和之前打开的渲染进程根域名是否相同，如果相同，则复用原来的进程，如果不同，则开启新的渲染进程，等待提交文档
1. 网络进程接受完数据后会通知主进程，主进程向渲染进程发送 `提交文档` 的消息，渲染进程收到后会直接与网络进程建立传输数据的管道，获取数据。全部接受后会向主进程返回 `确认提交` 的消息
1. 浏览器主进程在收到 `确认提交` 的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的URL、前进后退的历史状态，并更新文档，渲染进程开始处理
1. 解析HTML，生成DOM树；如果遇到style标签，采用另一个线程生成 CSS OM 树
1. 将DOM树和CSS OM树通过合成线程结合，生成最终的DOM树
1. 生成layout 布局树，生成相关的几何信息（内容必须在行盒中，行盒和块盒不能相邻）
1. 进行分层，减少后续操作开销
1. 生成绘制指令
1. 分块，将内容分为视口等分类
1. 光栅化，生成硬件可以理解的信息，交由GPU处理

#### 浏览器输入URL交由网络进程，网络进程做了哪些处理

1. 查找本地是否有强缓存，如果有，直接返回资源给浏览器进程
2. 检查本地host配置，查看是否配置了对应的host；如果没有，则进行DNS解析，获取服务器的IP地址；如果请求协议是HTTPS，建立TLS连接
3. 利用IP地址和服务器建立TCP连接（三次握手，四次挥手）
4. 浏览器构建请求头、请求行信息，并把该域名相关的Cookie等数据附加到请求头中，检查是否有协商缓存，有的话向服务器发送请求检查是否过期，没有则直接向服务器发送构建的请求信息
5. 服务器响应数据后，网络进程开始解析响应头，如果状态码为301或302，网络进程会读取响应头的location，获取重定向地址，重新发起请求
6. 判断响应头中的content-Type，如果为文件流类型，请求将提交给浏览器的下载管理器，流程结束，如果为HTML，则准备渲染

#### 浏览器新页面采用渲染进程策略

* 通常情况下，打开新的页面都会使用单独的渲染进程
* 如果A页面打开B页面，且A和B都属于同一站点的话，B则会复用A页面的渲染进程

> 同一站点：根域名及协议想同，包含了该域名下的所有子域名和不同端口号，如一下三个为同一站点

```js
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```





